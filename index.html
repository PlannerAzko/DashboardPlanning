<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLANNING SUPPORT 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
        }

        .header {
            background: linear-gradient(90deg, #d32f2f 0%, #c62828 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .filter-section {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: none;
            border-radius: 4px;
            background-color: #2a2a2a;
            color: #fff;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-group select:hover,
        .filter-group input:hover,
        .filter-group select:focus,
        .filter-group input:focus {
            background-color: #3a3a3a;
            outline: none;
            border-bottom: 2px solid #d32f2f;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .table-section {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .table-header {
            background-color: #1a1a1a;
            padding: 15px;
            font-weight: 600;
            color: #ffd700;
            border-bottom: 2px solid #d32f2f;
        }

        .table-content {
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        table thead {
            background-color: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table tfoot {
            background-color: #1a1a1a;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        table tfoot td {
            font-weight: bold;
            color: #ffd700;
            /* Spacer agar baris turun */
            border-top: 10px solid #2a2a2a; 
            /* Garis merah di atas baris hitam */
            box-shadow: inset 0 2px 0 0 #d32f2f;
            /* Menambahkan garis di bagian bawah baris TOTAL */
            border-bottom: 1px solid #444; 
            padding: 12px;
        }

        table th {
            padding: 12px;
            text-align: left;
            color: #ffd700;
            border-bottom: 1px solid #444;
            font-weight: 600;
        }

        table td {
            padding: 10px 12px;
            border-bottom: 1px solid #333;
        }

        table tbody tr:hover {
            background-color: #3a3a3a;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .kpi-card {
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-card.yellow {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
        }

        .kpi-card.red {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff4444 100%);
            color: #fff;
        }

        .kpi-label {
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .kpi-value {
            font-size: 2.2em;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .right-panel {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 4px;
        }

        .bottom-table {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .table-content-large {
            max-height: 400px;
            overflow-y: auto;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #d32f2f;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff6b6b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #ffd700;
        }

        .spinner {
            border: 4px solid #3a3a3a;
            border-top: 4px solid #d32f2f;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination {
            text-align: center;
            padding: 15px;
            color: #aaa;
        }

        .pagination button {
            background-color: #3a3a3a;
            color: #fff;
            border: none;
            padding: 8px 12px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover {
            background-color: #d32f2f;
        }

        /* Conditional formatting for JAM */
        .jam-pagi {
            background-color: rgba(255, 255, 200, 0.3) !important;
        }

        .jam-siang {
            background-color: rgba(173, 216, 230, 0.3) !important;
        }

        .jam-sore {
            background-color: rgba(144, 238, 144, 0.3) !important;
        }

        .jam-malam {
            background-color: rgba(211, 211, 211, 0.3) !important;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .filter-section {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .filter-section {
                grid-template-columns: repeat(2, 1fr);
            }

            .kpi-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>PLANNING SUPPORT 2026</h1>
    </div>

    <div class="container">
        <div class="filter-section">
            <div class="filter-group">
                <label for="bulan">BULAN</label>
                <select id="bulan">
                    <option value="">-- Semua Bulan --</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="stuffingDate">STUFFING DATE</label>
                <select id="stuffingDate">
                    <option value="">-- Semua Tanggal --</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="kota">KOTA</label>
                <select id="kota">
                    <option value="">-- Semua Kota --</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="regional">REGIONAL</label>
                <select id="regional">
                    <option value="">-- Semua Regional --</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="area">AREA</label>
                <select id="area">
                    <option value="">-- Semua Area --</option>
                </select>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="table-section">
                    <div class="table-header">
                        <i class="fas fa-table"></i> STUFFING DATE / CBM
                    </div>
                    <div class="table-content" id="crm-table-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading data...
                        </div>
                    </div>
                </div>

                <div class="kpi-container">
                    <div class="kpi-card yellow">
                        <div class="kpi-label">CASE ID SHIPPED</div>
                        <div class="kpi-value" id="caseIdShipped">0</div>
                    </div>
                    <div class="kpi-card yellow">
                        <div class="kpi-label">CASE ID PLAN</div>
                        <div class="kpi-value" id="caseIdPlan">0</div>
                    </div>
                    <div class="kpi-card red">
                        <div class="kpi-label">CBM SHIPPED</div>
                        <div class="kpi-value" id="cbmShipped">0</div>
                    </div>
                    <div class="kpi-card red">
                        <div class="kpi-label">CBM PLAN</div>
                        <div class="kpi-value" id="cbmPlan">0</div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div id="map"></div>
            </div>
        </div>

        <div class="bottom-table">
            <div class="table-header">
                <i class="fas fa-ship"></i> SHIPPING LINE DETAILS
            </div>
            <div class="table-content-large" id="shipping-table-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading data...
                </div>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script>
        // Google Sheets Configuration
        const SHEET_ID = '1ylgWBQJQgv0HjRiV9Ay-GYs__ywWUk8ZTSeb0KwaPsM';
        const SHEET_GID = '1144899065';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

        // Column Index Mapping (0-based)
        const COLUMNS = {
            A: 0,         // LC/ID
            D: 3,         // CARRIER
            I: 8,         // SHIPPINGLINE
            M: 12,        // JALUR
            Z: 25,        // CBM PLAN
            AN: 39,       // CASE ID PLAN (OLD)
            AO: 40,       // STUFFING DATE
            AP: 41,       // JAM
            AQ: 42,       // CASE ID PLAN (NEW)
            AR: 43,       // KOTA
            AS: 44,       // AREA
            AT: 45,       // REGIONAL
            AX: 49,       // BULAN
            AY: 50,       // CBM SHIPPED
            AZ: 51,       // CASE ID SHIPPED (OLD)
            BA: 52,       // ESTIMASI CASE ID
            BB: 53,       // CASE ID PLAN (BB)
            BF: 57        // CASE ID SHIPPED (BF)
        };

        // Kota Coordinates - More accurate locations using Google Maps data
        const kotaKoordinat = {
            // Uppercase variations
            'JAKARTA': [-6.2088, 106.8456],
            'SURABAYA': [-7.2575, 112.7521],
            'BALI': [-8.6705, 115.2126],
            'SEMARANG': [-6.9665, 110.4038],
            'BANDUNG': [-6.9175, 107.6191],
            'MEDAN': [3.5952, 98.6722],
            'MAKASSAR': [-5.3520, 119.5215],
            'YOGYAKARTA': [-7.7956, 110.3695],
            'KENDARI': [-3.9456, 122.5144],
            'SOLO': [-7.5505, 110.8242],
            'LOMBOK': [-8.6363, 116.3150],
            'KUDUS': [-6.9089, 110.8044],
            'PALEMBANG': [-2.9444, 104.7467],
            'BATAM': [1.1449, 104.0098],
            'JAMBI': [-1.6331, 103.5467],
            'PEKANBARU': [0.5431, 101.4471],
            'BANJARMASIN': [-3.3256, 114.5887],
            'KUPANG': [-10.1639, 123.5812],
            'MANADO': [1.4748, 124.8228],
            'MATARAM': [-8.5895, 116.2708],
            'PALANGKARAYA': [-1.9674, 111.4328],
            'PONTIANAK': [-0.0305, 109.3433],
            'SAMARINDA': [-0.4948, 117.1889],
            'SERANG': [-6.1256, 106.1505],
            'SEMARANG KOTA': [-6.9665, 110.4038],
            'SURAKARTA': [-7.5505, 110.8242],
            'TANGERANG': [-6.1728, 106.6326],
            'TASIKMALAYA': [-7.3500, 108.2000],
            'TEGAL': [-6.8641, 109.1306],
            'TERSANA': [-7.7500, 110.3833],
            'TOLITOLI': [0.9693, 121.1897],
            'TOMOHON': [1.3167, 124.8167],
            'TORAJA': [-2.9804, 119.6747],
            'TUBAN': [-6.8944, 111.9533],
            'TUNGKAL': [0.3187, 101.6339],
            'UMETARO': [-8.5895, 116.2708],
            'YOGYA': [-7.7956, 110.3695],
            
            // Mixed case variations
            'Jakarta': [-6.2088, 106.8456],
            'Surabaya': [-7.2575, 112.7521],
            'Bali': [-8.6705, 115.2126],
            'Semarang': [-6.9665, 110.4038],
            'Bandung': [-6.9175, 107.6191],
            'Medan': [3.5952, 98.6722],
            'Makassar': [-5.3520, 119.5215],
            'Yogyakarta': [-7.7956, 110.3695],
            'Kendari': [-3.9456, 122.5144],
            'Solo': [-7.5505, 110.8242],
            'Lombok': [-8.6363, 116.3150],
            'Kudus': [-6.9089, 110.8044],
            'Palembang': [-2.9444, 104.7467],
            'Batam': [1.1449, 104.0098],
            'Jambi': [-1.6331, 103.5467],
            'Pekanbaru': [0.5431, 101.4471],
            'Banjarmasin': [-3.3256, 114.5887],
            'Kupang': [-10.1639, 123.5812],
            'Manado': [1.4748, 124.8228],
            'Mataram': [-8.5895, 116.2708],
            'Palangkaraya': [-1.9674, 111.4328],
            'Pontianak': [-0.0305, 109.3433],
            'Samarinda': [-0.4948, 117.1889],
            'Serang': [-6.1256, 106.1505],
            'Surakarta': [-7.5505, 110.8242],
            'Tangerang': [-6.1728, 106.6326],
            'Tasikmalaya': [-7.3500, 108.2000],
            'Tegal': [-6.8641, 109.1306],
            'Tolitoli': [0.9693, 121.1897],
            'Tomohon': [1.3167, 124.8167],
            'Tuban': [-6.8944, 111.9533]
        };

        // Data Storage
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 100;
        let map;
        let markers = [];

        // Helper Function: Parse number with comma separator
        function parseNumberWithComma(value) {
            if (!value) return 0;
            // Hapus pemisah ribuan (koma) dan bersihkan spasi
            const cleaned = String(value).replace(/,/g, '').trim();
            return parseFloat(cleaned) || 0;
        }

        // Initialize Map
        function initMap() {
            map = L.map('map').setView([-2.5489, 118.0149], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // Fetch Data dari Google Sheets
        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                const csv = await response.text();
                parseCSV(csv);
                populateFilters();
                applyFilters();
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('crm-table-container').innerHTML = 
                    '<div class="loading">Error loading data. Please check console.</div>';
            }
        }

        // Parse CSV
        function parseCSV(csv) {
            const allRows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;

            // Robust CSV parsing handling quotes and newlines within cells
            for (let i = 0; i < csv.length; i++) {
                const char = csv[i];
                const nextChar = csv[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if ((char === '\n' || (char === '\r' && nextChar === '\n')) && !inQuotes) {
                    currentRow.push(currentField.trim());
                    allRows.push(currentRow);
                    currentRow = [];
                    currentField = '';
                    if (char === '\r') i++; // Skip \n
                } else {
                    currentField += char;
                }
            }
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                allRows.push(currentRow);
            }

            allData = [];
            // Start from i=1 to skip header
            for (let i = 1; i < allRows.length; i++) {
                const values = allRows[i];

                if (values.length > Math.max(...Object.values(COLUMNS))) {
                    const id = (values[COLUMNS.A] || '').trim();
                    const stuffingDate = (values[COLUMNS.AO] || '').trim();
                    const kota = (values[COLUMNS.AR] || '').trim();
                    
                    const cbmPlan = parseNumberWithComma(values[COLUMNS.Z]);
                    const caseIdPlan = parseNumberWithComma(values[COLUMNS.BB]);
                    const cbmShipped = parseNumberWithComma(values[COLUMNS.AY]);
                    const caseIdShipped = parseNumberWithComma(values[COLUMNS.BF]);
                    
                    const idLower = id.toLowerCase();
                    const kotaLower = kota.toLowerCase();
                    const dateLower = stuffingDate.toLowerCase();

                    // VALIDASI KETAT:
                    // 1. Baris data WAJIB memiliki ID, Tanggal Stuffing, dan Kota
                    if (!id || !stuffingDate || !kota) {
                        continue;
                    }

                    // 2. Lewati jika baris header yang berulang
                    if (idLower === 'lc/id' || idLower === 'id' || dateLower.includes('date')) {
                        continue;
                    }

                    // 3. Lewati jika baris ringkasan (Total/Jumlah/Subtotal/Summary)
                    // Kita periksa kolom ID, KOTA, dan TANGGAL
                    const summaryKeywords = ['total', 'jumlah', 'grand', 'subtotal', 'summary'];
                    const isSummary = summaryKeywords.some(k => 
                        idLower.includes(k) || 
                        kotaLower.includes(k) || 
                        dateLower.includes(k)
                    );
                    
                    if (isSummary) {
                        continue;
                    }

                    // 4. Lewati jika baris kosong/dekoratif (semua angka nol penting)
                    if (cbmPlan === 0 && caseIdPlan === 0 && cbmShipped === 0 && caseIdShipped === 0) {
                        continue;
                    }

                    allData.push({
                        A: id,
                        D: values[COLUMNS.D] || '',
                        I: values[COLUMNS.I] || '',
                        M: values[COLUMNS.M] || '',
                        Z: values[COLUMNS.Z] || '0',
                        AO: values[COLUMNS.AO] || '',
                        AP: values[COLUMNS.AP] || '',
                        AQ: values[COLUMNS.AQ] || '0',
                        AR: kota,
                        AS: values[COLUMNS.AS] || '',
                        AT: values[COLUMNS.AT] || '',
                        AX: values[COLUMNS.AX] || '',
                        AY: values[COLUMNS.AY] || '0',
                        AZ: values[COLUMNS.AZ] || '0',
                        BA: values[COLUMNS.BA] || '0',
                        BB: values[COLUMNS.BB] || '0',
                        BF: values[COLUMNS.BF] || '0'
                    });
                }
            }
        }

        // Populate Filter Options
        function populateFilters() {
            const bulanSet = new Set();
            const kotaSet = new Set();
            const regionalSet = new Set();
            const areaSet = new Set();
            const stuffingDateSet = new Set();

            allData.forEach(row => {
                if (row.AX) bulanSet.add(row.AX);
                if (row.AR) kotaSet.add(row.AR);
                if (row.AT) regionalSet.add(row.AT);
                if (row.AS) areaSet.add(row.AS);
                if (row.AO) stuffingDateSet.add(row.AO);
            });

            populateSelect('bulan', Array.from(bulanSet).sort());
            populateSelect('kota', Array.from(kotaSet).sort());
            populateSelect('regional', Array.from(regionalSet).sort());
            populateSelect('area', Array.from(areaSet).sort());
            // Sort dates from newest to oldest
            populateSelect('stuffingDate', Array.from(stuffingDateSet).sort().reverse());
        }

        function populateSelect(elementId, options) {
            const select = document.getElementById(elementId);
            const currentValue = select.value;
            
            while (select.options.length > 1) {
                select.remove(1);
            }

            options.forEach(option => {
                if (option) {
                    const optElement = document.createElement('option');
                    optElement.value = option;
                    optElement.textContent = option;
                    select.appendChild(optElement);
                }
            });

            select.value = currentValue;
        }

        // Apply Filters
        function applyFilters() {
            const bulan = document.getElementById('bulan').value;
            const stuffingDate = document.getElementById('stuffingDate').value;
            const kota = document.getElementById('kota').value;
            const regional = document.getElementById('regional').value;
            const area = document.getElementById('area').value;

            filteredData = allData.filter(row => {
                return (!bulan || row.AX === bulan) &&
                       (!stuffingDate || row.AO === stuffingDate) &&
                       (!kota || row.AR === kota) &&
                       (!regional || row.AT === regional) &&
                       (!area || row.AS === area);
            });

            currentPage = 1;
            updateDashboard();
        }

        // Get JAM color class - Updated schedule
        function getJamColorClass(jam) {
            if (!jam) return '';
            
            const jamNum = parseFloat(jam);
            
            // 08.00-10.00 : kuning muda
            if (jamNum >= 8 && jamNum < 10) {
                return 'jam-pagi';
            } 
            // 12.00-14.00 : biru muda
            else if (jamNum >= 12 && jamNum < 14) {
                return 'jam-siang';
            } 
            // 15.00-18.00 : hijau muda
            else if (jamNum >= 15 && jamNum < 18) {
                return 'jam-sore';
            } 
            // 19.00-21.00 : abu abu muda
            else if (jamNum >= 19 && jamNum < 21) {
                return 'jam-malam';
            }
            return '';
        }

        // Update Dashboard
        function updateDashboard() {
            updateCRMTable();
            updateShippingTable();
            updateKPIs();
            updateMap();
        }

        // Update CRM Table
        function updateCRMTable() {
            const container = document.getElementById('crm-table-container');

            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">No data found</div>';
                return;
            }

            const kotaData = {};
            const dates = new Set();

            filteredData.forEach(row => {
                const kota = row.AR;
                const date = row.AO;
                const cbm = parseNumberWithComma(row.Z);

                // Skip if kota is empty
                if (!kota || kota.trim() === '') {
                    return;
                }

                if (!kotaData[kota]) {
                    kotaData[kota] = {};
                }
                if (!kotaData[kota][date]) {
                    kotaData[kota][date] = 0;
                }
                kotaData[kota][date] += cbm;
                dates.add(date);
            });

            // Sort dates from newest to oldest
            const sortedDates = Array.from(dates).sort().reverse().slice(0, 4);
            const dateTotals = {};
            sortedDates.forEach(date => dateTotals[date] = 0);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>KOTA</th>
                            ${sortedDates.map(date => `<th>${date}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.keys(kotaData).sort((a, b) => a.localeCompare(b)).forEach(kota => {
                html += `<tr><td>${kota}</td>`;
                sortedDates.forEach(date => {
                    const cbm = kotaData[kota][date] || 0;
                    html += `<td>${cbm ? cbm.toFixed(2) : '-'}</td>`;
                    dateTotals[date] += cbm;
                });
                html += `</tr>`;
            });

            html += `</tbody>`;

            // Add Total Row
            html += `
                <tfoot>
                    <tr>
                        <td>TOTAL</td>
                        ${sortedDates.map(date => `<td>${dateTotals[date].toFixed(2)}</td>`).join('')}
                    </tr>
                </tfoot>
            `;

            html += `</table>`;
            container.innerHTML = html;
        }

        // Update Shipping Table
        function updateShippingTable() {
            const container = document.getElementById('shipping-table-container');

            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">No data found</div>';
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>LC</th>
                            <th>SHIPPINGLINE</th>
                            <th>CARRIER</th>
                            <th>STUFFING</th>
                            <th>JAM</th>
                            <th>JALUR</th>
                            <th>PLAN</th>
                            <th>SHIPPED</th>
                            <th>CASE ID PLAN</th>
                            <th>ESTIMASI CASE ID</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageData.forEach((row, index) => {
                const rowNum = start + index + 1;
                const jamColorClass = getJamColorClass(row.AP);
                // Parse dengan fungsi helper untuk menghapus koma
                const estimasiCaseId = parseNumberWithComma(row.BA);

                html += `
                    <tr class="${jamColorClass}">
                        <td>${rowNum}</td>
                        <td>${row.A || '-'}</td>
                        <td>${row.I || '-'}</td>
                        <td>${row.D || '-'}</td>
                        <td>${row.AO || '-'}</td>
                        <td>${row.AP || '-'}</td>
                        <td>${row.M || '-'}</td>
                        <td>${parseNumberWithComma(row.Z).toFixed(2) || '-'}</td>
                        <td>${parseNumberWithComma(row.AY).toFixed(2) || '-'}</td>
                        <td>${parseNumberWithComma(row.BB).toFixed(0) || '-'}</td>
                        <td>${estimasiCaseId.toFixed(0) || '-'}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            updatePagination(totalPages);
        }

        // Update Pagination
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            let html = `Page ${currentPage} / ${totalPages} &nbsp;`;

            if (currentPage > 1) {
                html += `<button onclick="goToPage(1)">« First</button>
                         <button onclick="goToPage(${currentPage - 1})">‹ Prev</button>`;
            }

            if (currentPage < totalPages) {
                html += `<button onclick="goToPage(${currentPage + 1})">Next ›</button>
                         <button onclick="goToPage(${totalPages})">Last »</button>`;
            }

            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            updateShippingTable();
            document.querySelector('.table-content-large').scrollTop = 0;
        }

        // Update KPIs
        function updateKPIs() {
            const caseIdShipped = filteredData.reduce((sum, r) => sum + parseNumberWithComma(r.BF), 0);
            const caseIdPlan = filteredData.reduce((sum, r) => sum + parseNumberWithComma(r.BB), 0);
            const cbmPlan = filteredData.reduce((sum, r) => sum + parseNumberWithComma(r.Z), 0);
            const cbmShipped = filteredData.reduce((sum, r) => sum + parseNumberWithComma(r.AY), 0);

            document.getElementById('caseIdShipped').textContent = caseIdShipped.toLocaleString('id-ID', {maximumFractionDigits: 0});
            document.getElementById('caseIdPlan').textContent = caseIdPlan.toLocaleString('id-ID', {maximumFractionDigits: 0});
            document.getElementById('cbmPlan').textContent = cbmPlan.toFixed(2);
            document.getElementById('cbmShipped').textContent = cbmShipped.toFixed(2);
        }

        // Update Map - More accurate city locations
        function updateMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const kotaCount = {};
            const kotaCBM = {};

            filteredData.forEach(row => {
                const kota = row.AR;
                const cbm = parseNumberWithComma(row.Z);

                if (kota) {
                    kotaCount[kota] = (kotaCount[kota] || 0) + 1;
                    kotaCBM[kota] = (kotaCBM[kota] || 0) + cbm;
                }
            });

            Object.keys(kotaCount).forEach(kota => {
                // Try to find coordinates from the mapping
                let coords = kotaKoordinat[kota];
                
                // If not found, try trimmed version
                if (!coords && kota.trim()) {
                    coords = kotaKoordinat[kota.trim()];
                }
                
                if (coords) {
                    const count = kotaCount[kota];
                    const cbm = kotaCBM[kota];

                    const marker = L.circleMarker(coords, {
                        radius: Math.min(Math.max(count / 2, 8), 25),
                        fillColor: '#d32f2f',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).bindPopup(`<strong>${kota}</strong><br/>Jumlah: ${count}<br/>CBM: ${cbm.toFixed(2)}`).addTo(map);
                    markers.push(marker);
                }
            });
        }

        // Event Listeners
        document.getElementById('bulan').addEventListener('change', applyFilters);
        document.getElementById('stuffingDate').addEventListener('change', applyFilters);
        document.getElementById('kota').addEventListener('change', applyFilters);
        document.getElementById('regional').addEventListener('change', applyFilters);
        document.getElementById('area').addEventListener('change', applyFilters);

        // Auto-refresh every 30 seconds
        setInterval(fetchData, 30000);

        // Initialize
        initMap();
        fetchData();
    </script>
</body>
</html>
