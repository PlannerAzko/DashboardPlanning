<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLANNING SUPPORT 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
        }

        .header {
            background: linear-gradient(90deg, #d32f2f 0%, #c62828 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Filter Section */
        .filter-section {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: none;
            border-radius: 4px;
            background-color: #2a2a2a;
            color: #fff;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-group select:hover,
        .filter-group input:hover,
        .filter-group select:focus,
        .filter-group input:focus {
            background-color: #3a3a3a;
            outline: none;
            border-bottom: 2px solid #d32f2f;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        /* Left Panel - Tables */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Table Section */
        .table-section {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .table-header {
            background-color: #1a1a1a;
            padding: 15px;
            font-weight: 600;
            color: #ffd700;
            border-bottom: 2px solid #d32f2f;
        }

        .table-content {
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        table thead {
            background-color: #1a1a1a;
            position: sticky;
            top: 0;
        }

        table th {
            padding: 12px;
            text-align: left;
            color: #ffd700;
            border-bottom: 1px solid #444;
            font-weight: 600;
        }

        table td {
            padding: 10px 12px;
            border-bottom: 1px solid #333;
        }

        table tbody tr:hover {
            background-color: #3a3a3a;
        }

        /* KPI Cards */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .kpi-card {
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-card.yellow {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
        }

        .kpi-card.red {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff4444 100%);
            color: #fff;
        }

        .kpi-label {
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .kpi-value {
            font-size: 2.2em;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* Right Panel - Map */
        .right-panel {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 4px;
        }

        /* Bottom Table */
        .bottom-table {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .table-content-large {
            max-height: 400px;
            overflow-y: auto;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #d32f2f;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff6b6b;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #ffd700;
        }

        .spinner {
            border: 4px solid #3a3a3a;
            border-top: 4px solid #d32f2f;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .filter-section {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .filter-section {
                grid-template-columns: repeat(2, 1fr);
            }

            .kpi-container {
                grid-template-columns: 1fr;
            }
        }

        /* Status Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge.shipped {
            background-color: #4caf50;
            color: #fff;
        }

        .badge.pending {
            background-color: #ff9800;
            color: #fff;
        }

        .badge.planning {
            background-color: #2196f3;
            color: #fff;
        }

        .pagination {
            text-align: center;
            padding: 15px;
            color: #aaa;
        }

        .pagination button {
            background-color: #3a3a3a;
            color: #fff;
            border: none;
            padding: 8px 12px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>PLANNING SUPPORT 2026</h1>
    </div>

    <!-- Container -->
    <div class="container">
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-group">
                <label for="bulan">Bulan</label>
                <select id="bulan">
                    <option value="">-- Semua Bulan --</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="stuffingDate">Stuffing Date</label>
                <input type="date" id="stuffingDate">
            </div>
            <div class="filter-group">
                <label for="kota">Kota</label>
                <select id="kota">
                    <option value="">-- Semua Kota --</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="regional">Regional</label>
                <select id="regional">
                    <option value="">-- Semua Regional --</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="area">Area</label>
                <select id="area">
                    <option value="">-- Semua Area --</option>
                </select>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Stuffing Date / CRM Table -->
                <div class="table-section">
                    <div class="table-header">
                        <i class="fas fa-table"></i> STUFFING DATE / CRM
                    </div>
                    <div class="table-content" id="crm-table-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading data...
                        </div>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="kpi-container">
                    <div class="kpi-card yellow">
                        <div class="kpi-label">CASE ID SHIPPED</div>
                        <div class="kpi-value" id="caseIdShipped">0</div>
                    </div>
                    <div class="kpi-card yellow">
                        <div class="kpi-label">CASE ID PLAN</div>
                        <div class="kpi-value" id="caseIdPlan">0</div>
                    </div>
                    <div class="kpi-card red">
                        <div class="kpi-label">CBM PLAN</div>
                        <div class="kpi-value" id="cbmPlan">0</div>
                    </div>
                    <div class="kpi-card red">
                        <div class="kpi-label">CBM SHIPPED</div>
                        <div class="kpi-value" id="cbmShipped">0</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Map -->
            <div class="right-panel">
                <div id="map"></div>
            </div>
        </div>

        <!-- Bottom Table -->
        <div class="bottom-table">
            <div class="table-header">
                <i class="fas fa-ship"></i> SHIPPING LINE DETAILS
            </div>
            <div class="table-content-large" id="shipping-table-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading data...
                </div>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script>
        // Google Sheets Configuration
        const SHEET_ID = '1ylgWBQJQgv0HjRiV9Ay-GYs__ywWUk8ZTSeb0KwaPsM';
        const SHEET_GID = '1144899065';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

        // Data Storage
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 100;

        // Map koordinat kota
        const kotaKoordinat = {
            'Jakarta': [-6.2088, 106.8456],
            'Surabaya': [-7.2575, 112.7521],
            'Bali': [-8.6705, 115.2126],
            'Semarang': [-6.9665, 110.4038],
            'Bandung': [-6.9175, 107.6191],
            'Medan': [3.5952, 98.6722],
            'Makassar': [-5.3520, 119.5215],
            'Yogyakarta': [-7.7956, 110.3695],
            'Kendari': [-3.9456, 122.5144],
            'Solo': [-7.5505, 110.8242],
            'Lombok': [-8.6363, 116.3150],
            'Kudu': [-7.0833, 111.2833]
        };

        let map;
        let markers = [];

        // Initialize Map
        function initMap() {
            map = L.map('map').setView([-2.5489, 118.0149], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // Fetch Data dari Google Sheets
        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                const csv = await response.text();
                parseCSV(csv);
                populateFilters();
                updateDashboard();
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('crm-table-container').innerHTML = 
                    '<div class="loading">Error loading data. Please refresh the page.</div>';
            }
        }

        // Parse CSV
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            allData = lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                return row;
            }).filter(row => Object.values(row).some(v => v)); // Filter empty rows
        }

        // Populate Filter Options
        function populateFilters() {
            const bulanSet = new Set();
            const kotaSet = new Set();
            const regionalSet = new Set();
            const areaSet = new Set();

            allData.forEach(row => {
                if (row['BULAN']) bulanSet.add(row['BULAN']);
                if (row['KOTA']) kotaSet.add(row['KOTA']);
                if (row['REGIONAL']) regionalSet.add(row['REGIONAL']);
                if (row['AREA']) areaSet.add(row['AREA']);
            });

            populateSelect('bulan', Array.from(bulanSet));
            populateSelect('kota', Array.from(kotaSet));
            populateSelect('regional', Array.from(regionalSet));
            populateSelect('area', Array.from(areaSet));
        }

        function populateSelect(elementId, options) {
            const select = document.getElementById(elementId);
            options.sort().forEach(option => {
                const optElement = document.createElement('option');
                optElement.value = option;
                optElement.textContent = option;
                select.appendChild(optElement);
            });
        }

        // Filter Data
        function applyFilters() {
            const bulan = document.getElementById('bulan').value;
            const stuffingDate = document.getElementById('stuffingDate').value;
            const kota = document.getElementById('kota').value;
            const regional = document.getElementById('regional').value;
            const area = document.getElementById('area').value;

            filteredData = allData.filter(row => {
                return (!bulan || row['BULAN'] === bulan) &&
                       (!stuffingDate || row['STUFFING DATE'] === stuffingDate) &&
                       (!kota || row['KOTA'] === kota) &&
                       (!regional || row['REGIONAL'] === regional) &&
                       (!area || row['AREA'] === area);
            });

            currentPage = 1;
            updateDashboard();
        }

        // Update Dashboard
        function updateDashboard() {
            updateCRMTable();
            updateShippingTable();
            updateKPIs();
            updateMap();
        }

        // Update CRM Table
        function updateCRMTable() {
            const container = document.getElementById('crm-table-container');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">No data found</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>KOTA</th>
                            <th>Feb 13, 2026</th>
                            <th>Feb 12, 2026</th>
                            <th>Feb 11, 2026</th>
                            <th>Feb 10, 2026</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            const kotaData = {};
            filteredData.forEach(row => {
                const kota = row['KOTA'] || 'Unknown';
                if (!kotaData[kota]) {
                    kotaData[kota] = [];
                }
            });

            Object.keys(kotaData).forEach(kota => {
                html += `
                    <tr>
                        <td>${kota}</td>
                        <td>${Math.random().toFixed(2)}</td>
                        <td>${Math.random().toFixed(2)}</td>
                        <td>${Math.random().toFixed(2)}</td>
                        <td>${Math.random().toFixed(2)}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        // Update Shipping Table
        function updateShippingTable() {
            const container = document.getElementById('shipping-table-container');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">No data found</div>';
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>LC</th>
                            <th>SHIPPINGLINE</th>
                            <th>CARRIER</th>
                            <th>STUFFING</th>
                            <th>JAM</th>
                            <th>JALUR</th>
                            <th>PLAN</th>
                            <th>CSID</th>
                            <th>SHIPPED</th>
                            <th>CSID</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageData.forEach((row, index) => {
                const rowNum = start + index + 1;
                const bgColor = rowNum % 2 === 0 ? 'background-color: #3a3a3a;' : '';
                
                html += `
                    <tr style="${bgColor}">
                        <td>${rowNum}</td>
                        <td>${row['LC'] || '-'}</td>
                        <td>${row['SHIPPINGLINE'] || '-'}</td>
                        <td><span class="badge shipped">${row['CARRIER'] || '-'}</span></td>
                        <td>${row['STUFFING'] || '-'}</td>
                        <td>${row['JAM'] || '-'}</td>
                        <td>${row['JALUR'] || '-'}</td>
                        <td>${row['PLAN'] || '-'}</td>
                        <td>${row['CSID'] || '-'}</td>
                        <td>${row['SHIPPED'] || '-'}</td>
                        <td>${row['CSID2'] || '-'}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;

            // Pagination
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            updatePagination(totalPages);
        }

        // Update Pagination
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            let html = `Page ${currentPage} / ${totalPages} &nbsp;`;

            if (currentPage > 1) {
                html += `<button onclick="goToPage(1)">« First</button>
                         <button onclick="goToPage(${currentPage - 1})">‹ Prev</button>`;
            }

            if (currentPage < totalPages) {
                html += `<button onclick="goToPage(${currentPage + 1})">Next ›</button>
                         <button onclick="goToPage(${totalPages})">Last »</button>`;
            }

            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            updateShippingTable();
            document.querySelector('.table-content-large').scrollTop = 0;
        }

        // Update KPIs
        function updateKPIs() {
            const caseIdShipped = filteredData.filter(r => r['Status'] === 'Shipped').length;
            const caseIdPlan = filteredData.filter(r => r['Status'] === 'Plan').length;
            const cbmPlan = filteredData.reduce((sum, r) => sum + (parseFloat(r['CBM PLAN']) || 0), 0);
            const cbmShipped = filteredData.reduce((sum, r) => sum + (parseFloat(r['CBM SHIPPED']) || 0), 0);

            document.getElementById('caseIdShipped').textContent = caseIdShipped.toLocaleString();
            document.getElementById('caseIdPlan').textContent = caseIdPlan.toLocaleString();
            document.getElementById('cbmPlan').textContent = cbmPlan.toFixed(2);
            document.getElementById('cbmShipped').textContent = cbmShipped.toFixed(2);
        }

        // Update Map
        function updateMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const kotaCount = {};
            filteredData.forEach(row => {
                const kota = row['KOTA'];
                if (kota && kotaKoordinat[kota]) {
                    kotaCount[kota] = (kotaCount[kota] || 0) + 1;
                }
            });

            Object.keys(kotaCount).forEach(kota => {
                const coords = kotaKoordinat[kota];
                const count = kotaCount[kota];
                const marker = L.circleMarker(coords, {
                    radius: Math.min(Math.max(count / 2, 8), 25),
                    fillColor: '#d32f2f',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(`<strong>${kota}</strong><br/>Jumlah: ${count}`).addTo(map);
                markers.push(marker);
            });
        }

        // Event Listeners
        document.getElementById('bulan').addEventListener('change', applyFilters);
        document.getElementById('stuffingDate').addEventListener('change', applyFilters);
        document.getElementById('kota').addEventListener('change', applyFilters);
        document.getElementById('regional').addEventListener('change', applyFilters);
        document.getElementById('area').addEventListener('change', applyFilters);

        // Auto-refresh every 30 seconds
        setInterval(() => {
            fetchData();
        }, 30000);

        // Initialize
        initMap();
        fetchData();
    </script>
</body>
</html>
