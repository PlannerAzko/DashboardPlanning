<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLANNING SUPPORT 2026 - Stabilized</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a1a; color: #fff; }

        .header {
            background: linear-gradient(90deg, #d32f2f 0%, #c62828 100%);
            padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 15px; }

        .filter-section {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px;
        }

        .filter-group label { font-size: 0.75em; font-weight: 600; color: #aaa; margin-bottom: 5px; display: block; }

        /* Multi-select styling */
        .multi-select-container { position: relative; background-color: #2a2a2a; border-radius: 4px; border-bottom: 2px solid transparent; }
        .multi-select-display {
            padding: 10px; color: #fff; font-size: 0.9em; cursor: pointer;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: flex; justify-content: space-between; align-items: center;
        }
        .multi-select-display::after { content: '\f0d7'; font-family: 'Font Awesome 6 Free'; font-weight: 900; margin-left: 8px; color: #d32f2f; }
        
        .multi-select-options {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background-color: #2a2a2a; border: 1px solid #444; z-index: 9999;
            max-height: 250px; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .multi-select-options.show { display: block; }
        .option-item { padding: 8px 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .option-item:hover { background: #3a3a3a; }
        .option-item input { width: 16px; height: 16px; accent-color: #d32f2f; cursor: pointer; }
        .option-item label { flex: 1; cursor: pointer; margin: 0; color: #eee; font-size: 0.85em; }

        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .table-section, .right-panel, .bottom-table { background-color: #2a2a2a; border-radius: 4px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .table-header { background-color: #111; padding: 12px; font-weight: 600; color: #ffd700; border-bottom: 2px solid #d32f2f; font-size: 0.9em; }

        #map { width: 100%; height: 500px; z-index: 1; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th { background-color: #111; padding: 10px; text-align: left; color: #ffd700; position: sticky; top: 0; z-index: 2; }
        td { padding: 8px 10px; border-bottom: 1px solid #333; }
        tbody tr:hover { background-color: #333; }

        .kpi-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .kpi-card { padding: 15px; border-radius: 6px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .kpi-card.yellow { background: linear-gradient(135deg, #ffd700 0%, #ccac00 100%); color: #000; }
        .kpi-card.red { background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); color: #fff; }
        .kpi-value { font-size: 1.8em; font-weight: bold; }
        .kpi-label { font-size: 0.7em; font-weight: bold; text-transform: uppercase; opacity: 0.8; }

        .jam-pagi { background-color: rgba(255, 235, 59, 0.1) !important; }
        .jam-siang { background-color: rgba(33, 150, 243, 0.1) !important; }
        .jam-sore { background-color: rgba(76, 175, 80, 0.1) !important; }
        .jam-malam { background-color: rgba(158, 158, 158, 0.1) !important; }

        .pagination { padding: 10px; text-align: center; background: #1a1a1a; display: flex; justify-content: center; align-items: center; gap: 15px; }
        .pagination button { background: #d32f2f; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .pagination button:disabled { background: #555; cursor: not-allowed; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d32f2f; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>PLANNING SUPPORT 2026</h1>
    </div>

    <div class="container">
        <div class="filter-section">
            <div class="filter-group">
                <label>BULAN</label>
                <div class="multi-select-container" id="bulan-container">
                    <div class="multi-select-display" id="bulan-display">-- Pilih --</div>
                    <div class="multi-select-options" id="bulan-options"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>STUFFING DATE</label>
                <div class="multi-select-container" id="stuffingDate-container">
                    <div class="multi-select-display" id="stuffingDate-display">-- Pilih --</div>
                    <div class="multi-select-options" id="stuffingDate-options"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>KOTA</label>
                <div class="multi-select-container" id="kota-container">
                    <div class="multi-select-display" id="kota-display">-- Pilih --</div>
                    <div class="multi-select-options" id="kota-options"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>REGIONAL</label>
                <div class="multi-select-container" id="regional-container">
                    <div class="multi-select-display" id="regional-display">-- Pilih --</div>
                    <div class="multi-select-options" id="regional-options"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>AREA</label>
                <div class="multi-select-container" id="area-container">
                    <div class="multi-select-display" id="area-display">-- Pilih --</div>
                    <div class="multi-select-options" id="area-options"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="table-section">
                    <div class="table-header"><i class="fas fa-calendar-day"></i> CBM SUMMARY PER DATE</div>
                    <div style="max-height: 250px; overflow-y: auto;" id="crm-table-container"></div>
                </div>
                <div class="kpi-container">
                    <div class="kpi-card yellow"><div class="kpi-label">CASE ID SHIPPED</div><div class="kpi-value" id="caseIdShipped">0</div></div>
                    <div class="kpi-card yellow"><div class="kpi-label">CASE ID PLAN</div><div class="kpi-value" id="caseIdPlan">0</div></div>
                    <div class="kpi-card red"><div class="kpi-label">CBM SHIPPED</div><div class="kpi-value" id="cbmShipped">0</div></div>
                    <div class="kpi-card red"><div class="kpi-label">CBM PLAN</div><div class="kpi-value" id="cbmPlan">0</div></div>
                </div>
            </div>
            <div class="right-panel">
                <div id="map"></div>
            </div>
        </div>

        <div class="bottom-table">
            <div class="table-header"><i class="fas fa-truck-loading"></i> SHIPPING LINE DETAILS</div>
            <div style="max-height: 400px; overflow-y: auto;" id="shipping-table-container"></div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const CSV_URL = `https://docs.google.com/spreadsheets/d/1ylgWBQJQgv0HjRiV9Ay-GYs__ywWUk8ZTSeb0KwaPsM/export?format=csv&gid=1144899065`;
        
        // Kolom Mapping
        const COL = { LC:0, SL:8, CBMP:25, DATE:40, JAM:41, KOTA:43, AREA:44, REG:45, BLN:49, CBMS:50, CASEP:53, CASES:57 };

        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let map, markers = [];
        let isInitialLoad = true;
        let selectedFilters = { bulan: [], stuffingDate: [], kota: [], regional: [], area: [] };

        const kotaKoordinat = {
            'JAKARTA': [-6.2088, 106.8456], 'SURABAYA': [-7.2575, 112.7521], 'BALI': [-8.6705, 115.2126],
            'SEMARANG': [-6.9665, 110.4038], 'BANDUNG': [-6.9175, 107.6191], 'MEDAN': [3.5952, 98.6722],
            'MAKASSAR': [-5.3520, 119.5215], 'YOGYAKARTA': [-7.7956, 110.3695], 'KENDARI': [-3.9456, 122.5144],
            'SOLO': [-7.5505, 110.8242], 'PALEMBANG': [-2.9444, 104.7467]
        };

        // Initialize App
        async function init() {
            initMap();
            await fetchData();
            // Auto refresh data saja, bukan UI filternya
            setInterval(fetchData, 30000);
        }

        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                parseCSV(csvText);
                
                if (isInitialLoad) {
                    populateFilters();
                    isInitialLoad = false;
                }
                
                applyFilters();
            } catch (error) {
                console.error("Gagal mengambil data:", error);
            }
        }

        function parseCSV(text) {
            const rows = text.split('\n');
            const dataTemp = [];
            for (let i = 1; i < rows.length; i++) {
                const cols = rows[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                if (cols.length < 50 || !cols[COL.LC]) continue;

                dataTemp.push({
                    lc: cols[COL.LC], sl: cols[COL.SL], 
                    cbmp: parseFloat(cols[COL.CBMP]) || 0,
                    date: cols[COL.DATE], jam: cols[COL.JAM],
                    kota: cols[COL.KOTA], area: cols[COL.AREA],
                    reg: cols[COL.REG], bln: cols[COL.BLN],
                    cbms: parseFloat(cols[COL.CBMS]) || 0,
                    casep: parseFloat(cols[COL.CASEP]) || 0,
                    cases: parseFloat(cols[COL.CASES]) || 0
                });
            }
            allData = dataTemp;
        }

        function populateFilters() {
            const getUnik = (key) => [...new Set(allData.map(item => item[key]))].filter(Boolean).sort();
            
            setupMultiSelect('bulan', getUnik('bln'));
            setupMultiSelect('stuffingDate', getUnik('date').reverse());
            setupMultiSelect('kota', getUnik('kota'));
            setupMultiSelect('regional', getUnik('reg'));
            setupMultiSelect('area', getUnik('area'));
        }

        function setupMultiSelect(filterId, options) {
            const container = document.getElementById(`${filterId}-options`);
            const display = document.getElementById(`${filterId}-display`);
            
            let html = `
                <div class="option-item" style="background:#111; position:sticky; top:0;">
                    <input type="checkbox" id="${filterId}-all">
                    <label for="${filterId}-all" style="color:#ffd700; font-weight:bold;">PILIH SEMUA</label>
                </div>
            `;
            
            options.forEach(opt => {
                html += `
                    <div class="option-item">
                        <input type="checkbox" class="${filterId}-cb" value="${opt}" id="${filterId}-${opt}">
                        <label for="${filterId}-${opt}">${opt}</label>
                    </div>
                `;
            });
            
            container.innerHTML = html;

            // Toggle Dropdown
            display.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.multi-select-options').forEach(el => {
                    if (el.id !== `${filterId}-options`) el.classList.remove('show');
                });
                container.classList.toggle('show');
            });

            // Handle Checkbox Logic
            const masterCb = document.getElementById(`${filterId}-all`);
            const itemCbs = document.querySelectorAll(`.${filterId}-cb`);

            masterCb.addEventListener('change', () => {
                itemCbs.forEach(cb => cb.checked = masterCb.checked);
                updateFilterState(filterId);
            });

            itemCbs.forEach(cb => {
                cb.addEventListener('change', () => {
                    masterCb.checked = [...itemCbs].every(c => c.checked);
                    updateFilterState(filterId);
                });
            });
        }

        function updateFilterState(id) {
            const checked = [...document.querySelectorAll(`.${id}-cb:checked`)].map(c => c.value);
            selectedFilters[id] = checked;
            
            const display = document.getElementById(`${id}-display`);
            display.innerText = checked.length === 0 ? '-- Pilih --' : 
                                checked.length === document.querySelectorAll(`.${id}-cb`).length ? 'Semua' : 
                                `${checked.length} Terpilih`;
            
            applyFilters();
        }

        function applyFilters() {
            filteredData = allData.filter(d => {
                const mBln = selectedFilters.bulan.length === 0 || selectedFilters.bulan.includes(d.bln);
                const mTgl = selectedFilters.stuffingDate.length === 0 || selectedFilters.stuffingDate.includes(d.date);
                const mKota = selectedFilters.kota.length === 0 || selectedFilters.kota.includes(d.kota);
                const mReg = selectedFilters.regional.length === 0 || selectedFilters.regional.includes(d.reg);
                const mArea = selectedFilters.area.length === 0 || selectedFilters.area.includes(d.area);
                return mBln && mTgl && mKota && mReg && mArea;
            });

            renderDashboard();
        }

        function renderDashboard() {
            renderCRMTable();
            renderShippingTable();
            renderKPIs();
            updateMapMarkers();
        }

        function renderCRMTable() {
            const container = document.getElementById('crm-table-container');
            const dates = [...new Set(filteredData.map(d => d.date))].sort().reverse().slice(0, 5);
            const kotaData = {};

            filteredData.forEach(d => {
                if (!kotaData[d.kota]) kotaData[d.kota] = {};
                kotaData[d.kota][d.date] = (kotaData[d.kota][d.date] || 0) + d.cbmp;
            });

            let html = `<table><thead><tr><th>KOTA</th>${dates.map(dt => `<th>${dt}</th>`).join('')}</tr></thead><tbody>`;
            Object.keys(kotaData).sort().forEach(k => {
                html += `<tr><td>${k}</td>${dates.map(dt => `<td>${(kotaData[k][dt] || 0).toFixed(1)}</td>`).join('')}</tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderShippingTable() {
            const container = document.getElementById('shipping-table-container');
            const start = (currentPage - 1) * itemsPerPage;
            const dataSubset = filteredData.slice(start, start + itemsPerPage);

            let html = `<table><thead><tr><th>LC</th><th>SL</th><th>DATE</th><th>JAM</th><th>PLAN</th><th>SHIPPED</th></tr></thead><tbody>`;
            dataSubset.forEach(d => {
                const jamClass = getJamClass(d.jam);
                html += `<tr class="${jamClass}">
                    <td>${d.lc}</td><td>${d.sl}</td><td>${d.date}</td><td>${d.jam}</td>
                    <td>${d.cbmp.toFixed(1)}</td><td>${d.cbms.toFixed(1)}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
            renderPagination();
        }

        function renderPagination() {
            const total = Math.ceil(filteredData.length / itemsPerPage);
            document.getElementById('pagination').innerHTML = `
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="movePage(-1)">Prev</button>
                <span style="font-size:0.8em">Hal ${currentPage} / ${total || 1}</span>
                <button ${currentPage >= total ? 'disabled' : ''} onclick="movePage(1)">Next</button>
            `;
        }

        window.movePage = (step) => { currentPage += step; renderShippingTable(); };

        function renderKPIs() {
            const sum = (key) => filteredData.reduce((acc, curr) => acc + curr[key], 0);
            document.getElementById('caseIdShipped').innerText = sum('cases').toLocaleString();
            document.getElementById('caseIdPlan').innerText = sum('casep').toLocaleString();
            document.getElementById('cbmShipped').innerText = sum('cbms').toFixed(1);
            document.getElementById('cbmPlan').innerText = sum('cbmp').toFixed(1);
        }

        function initMap() {
            map = L.map('map').setView([-2.5, 118], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        function updateMapMarkers() {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const kotaCount = {};
            filteredData.forEach(d => { if(d.kota) kotaCount[d.kota] = (kotaCount[d.kota] || 0) + 1; });

            Object.entries(kotaCount).forEach(([kota, val]) => {
                const coord = kotaKoordinat[kota.toUpperCase()];
                if (coord) {
                    const m = L.circleMarker(coord, { radius: 10, color: '#d32f2f', fillOpacity: 0.6 })
                        .bindPopup(`<b>${kota}</b><br>Total: ${val} shipping`)
                        .addTo(map);
                    markers.push(m);
                }
            });
        }

        function getJamClass(jam) {
            const h = parseFloat(jam);
            if (h >= 8 && h < 11) return 'jam-pagi';
            if (h >= 11 && h < 15) return 'jam-siang';
            if (h >= 15 && h < 19) return 'jam-sore';
            if (h >= 19) return 'jam-malam';
            return '';
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', () => {
            document.querySelectorAll('.multi-select-options').forEach(el => el.classList.remove('show'));
        });

        init();
    </script>
</body>
</html>
