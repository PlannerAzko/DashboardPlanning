<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLANNING SUPPORT 2026</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #fff;
        }

        .header {
            background: linear-gradient(90deg, #d32f2f 0%, #c62828 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .container {
            max-width: 95%; /* Meningkatkan lebar maksimal agar lebih luas */
            margin: 0 auto;
            padding: 20px;
        }

        .filter-section {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: none;
            border-radius: 4px;
            background-color: #2a2a2a;
            color: #fff;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* Multi-select styling */
        .multi-select-container {
            position: relative;
            background-color: #2a2a2a;
            border-radius: 4px;
            cursor: pointer;
            min-height: 45px;
        }

        .multi-select-display {
            padding: 12px;
            color: #fff;
            font-size: 0.95em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-display::after {
            content: '\f0d7';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            margin-left: 10px;
            color: #aaa;
        }

        .multi-select-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #2a2a2a;
            border: 1px solid #444;
            z-index: 3000; /* Ditingkatkan agar pasti di atas peta Leaflet */
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border-radius: 0 0 4px 4px;
        }

        .multi-select-options.show {
            display: block;
        }

        .option-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
        }

        .option-item:hover {
            background-color: #3a3a3a;
        }

        .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #d32f2f;
        }

        .option-item label {
            margin-bottom: 0;
            cursor: pointer;
            color: #fff;
            flex: 1;
        }

        .select-all-btn {
            background-color: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 1;
            font-weight: bold;
            color: #ffd700;
        }

        .filter-group select:hover,
        .filter-group input:hover,
        .filter-group select:focus,
        .filter-group input:focus {
            background-color: #3a3a3a;
            outline: none;
            border-bottom: 2px solid #d32f2f;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .table-section {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .table-header {
            background-color: #1a1a1a;
            padding: 15px;
            font-weight: 600;
            color: #ffd700;
            border-bottom: 2px solid #d32f2f;
        }

        .table-content {
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        table thead {
            background-color: #1a1a1a;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        table tfoot {
            background-color: #1a1a1a;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        table tfoot td {
            font-weight: bold;
            color: #ffd700;
            /* REVISI 1: Spacer ditingkatkan ke 10px agar baris lebih turun */
            border-top: 10px solid #2a2a2a; 
            /* Garis merah tetap presisi di atas baris hitam */
            box-shadow: inset 0 2px 0 0 #d32f2f;
            /* REVISI 3: Padding disesuaikan agar teks presisi di tengah */
            padding: 15px 12px; 
            border-bottom: none;
        }

        table th {
            padding: 12px;
            text-align: left;
            color: #ffd700;
            border-bottom: 1px solid #444;
            font-weight: 600;
        }

        table td {
            padding: 10px 12px;
            border-bottom: 1px solid #333;
        }

        table tbody tr:hover {
            background-color: #3a3a3a;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .kpi-container-four {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-card {
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-card.yellow {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
        }

        .kpi-card.red {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff4444 100%);
            color: #fff;
        }

        .kpi-card.blue {
            background: linear-gradient(135deg, #006994 0%, #00a8e8 100%);
            color: #fff;
        }

        .kpi-label {
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .kpi-value {
            font-size: 2.2em;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .right-panel {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 4px;
        }

        .bottom-table {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .table-content-large {
            max-height: 650px; /* Meningkatkan jarak vertikal antara header dan footer */
            overflow-y: auto;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #d32f2f;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff6b6b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #ffd700;
        }

        .spinner {
            border: 4px solid #3a3a3a;
            border-top: 4px solid #d32f2f;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pagination {
            text-align: center;
            padding: 15px;
            color: #aaa;
        }

        .pagination button {
            background-color: #3a3a3a;
            color: #fff;
            border: none;
            padding: 8px 12px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover {
            background-color: #d32f2f;
        }

        /* Chart Styles */
        .chart-section {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Menjadi 2 kolom agar sejajar */
            gap: 20px;
            margin-top: 25px;
        }

        .chart-container {
            background-color: #2a2a2a;
            border-radius: 4px;
            overflow: hidden; /* Agar header bulat di pojok */
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        .chart-body {
            padding: 20px;
            height: 350px; /* Tinggi tetap agar tidak bergerak */
            position: relative;
        }

        /* Extra Section Styles */
        .extra-section {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 20px;
            margin-top: 25px;
        }

        .extra-left, .extra-right {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .table-content-extra {
            max-height: 450px;
            overflow-y: auto;
        }

        .nested-header th {
            text-align: center;
            border-bottom: 2px solid #444;
        }

        .sub-header th {
            font-size: 0.8em;
            background-color: #222;
        }

        /* Conditional formatting for JAM */
        .jam-pagi {
            background-color: rgba(255, 255, 200, 0.3) !important;
        }

        .jam-siang {
            background-color: rgba(173, 216, 230, 0.3) !important;
        }

        .jam-sore {
            background-color: rgba(144, 238, 144, 0.3) !important;
        }

        .jam-malam {
            background-color: rgba(211, 211, 211, 0.3) !important;
        }

        @media (max-width: 1200px) {
            .main-content, .chart-section, .kpi-container-four {
                grid-template-columns: 1fr;
            }

            .filter-section {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .filter-section {
                grid-template-columns: repeat(2, 1fr);
            }

            .kpi-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>PLANNING SUPPORT 2026</h1>
    </div>

    <div class="container">
        <div class="filter-section">
            <div class="filter-group">
                <label>BULAN</label>
                <div class="multi-select-container" id="bulan-container">
                    <div class="multi-select-display" id="bulan-display">-- Semua Bulan --</div>
                    <div class="multi-select-options" id="bulan-options"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>STUFFING DATE</label>
                <div class="multi-select-container" id="stuffingDate-container">
                    <div class="multi-select-display" id="stuffingDate-display">-- Semua Tanggal --</div>
                    <div class="multi-select-options" id="stuffingDate-options"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>KOTA</label>
                <div class="multi-select-container" id="kota-container">
                    <div class="multi-select-display" id="kota-display">-- Semua Kota --</div>
                    <div class="multi-select-options" id="kota-options"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>REGIONAL</label>
                <div class="multi-select-container" id="regional-container">
                    <div class="multi-select-display" id="regional-display">-- Semua Regional --</div>
                    <div class="multi-select-options" id="regional-options"></div>
                </div>
            </div>
            <div class="filter-group">
                <label>AREA</label>
                <div class="multi-select-container" id="area-container">
                    <div class="multi-select-display" id="area-display">-- Semua Area --</div>
                    <div class="multi-select-options" id="area-options"></div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="table-section">
                    <div class="table-header">
                        <i class="fas fa-table"></i> STUFFING DATE / CBM
                    </div>
                    <div class="table-content" id="crm-table-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading data...
                        </div>
                    </div>
                </div>

                <div class="kpi-container">
                    <div class="kpi-card yellow">
                        <div class="kpi-label">CASE ID SHIPPED</div>
                        <div class="kpi-value" id="caseIdShipped">0</div>
                    </div>
                    <div class="kpi-card yellow">
                        <div class="kpi-label">CASE ID PLAN</div>
                        <div class="kpi-value" id="caseIdPlan">0</div>
                    </div>
                    <div class="kpi-card red">
                        <div class="kpi-label">CBM SHIPPED</div>
                        <div class="kpi-value" id="cbmShipped">0</div>
                    </div>
                    <div class="kpi-card red">
                        <div class="kpi-label">CBM PLAN</div>
                        <div class="kpi-value" id="cbmPlan">0</div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div id="map"></div>
            </div>
        </div>

        <div class="kpi-container-four">
            <div class="kpi-card blue">
                <div class="kpi-label">CASE ID PLAN B1</div>
                <div class="kpi-value" id="caseIdPlanB1">0</div>
            </div>
            <div class="kpi-card blue">
                <div class="kpi-label">CASE ID PLAN B2</div>
                <div class="kpi-value" id="caseIdPlanB2">0</div>
            </div>
            <div class="kpi-card blue">
                <div class="kpi-label">CASE ID PLAN B3</div>
                <div class="kpi-value" id="caseIdPlanB3">0</div>
            </div>
            <div class="kpi-card blue">
                <div class="kpi-label">CASE ID PLAN B4</div>
                <div class="kpi-value" id="caseIdPlanB4">0</div>
            </div>
        </div>

        <div class="bottom-table">
            <div class="table-header">
                <i class="fas fa-ship"></i> SHIPPING LINE DETAILS
            </div>
            <div class="table-content-large" id="shipping-table-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading data...
                </div>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>

        <div class="chart-section">
            <div class="chart-container">
                <div class="table-header">
                    <i class="fas fa-chart-line"></i> SLA PERFORMANCE (CUSTOMER vs GRW)
                </div>
                <div class="chart-body">
                    <canvas id="slaChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="table-header">
                    <i class="fas fa-chart-area"></i> CBM PLAN-TO-ACTUAL RATIO (%)
                </div>
                <div class="chart-body">
                    <canvas id="cbmRatioChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Extra Section (New Tables & Charts) -->
        <div class="extra-section">
            <div class="extra-left">
                <!-- Table 1: CBM & City Summary -->
                <div class="bottom-table">
                    <div class="table-header" style="color: #ffd700;">
                        <i class="fas fa-city"></i> CBM & CONTAINER BY CITY : UNSUPPORTED & DELAYED
                    </div>
                    <div class="table-content-extra" id="city-summary-table">
                        <div class="loading">Processing data...</div>
                    </div>
                </div>
                
                <!-- Percentage Breakdown Charts -->
                <div class="chart-container" style="margin-top: 20px;">
                    <div class="table-header" style="color: #ffd700;">
                        <i class="fas fa-percentage"></i> PERCENTAGE BREAKDOWN
                    </div>
                    <div class="chart-body" style="height: 280px;">
                        <canvas id="vendorResponseChart"></canvas>
                    </div>
                    <div class="chart-body" style="height: 280px; border-top: 1px solid #333;">
                        <canvas id="agingTerlambatChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="extra-right">
                <!-- Table 2: Vendor Support Not Available -->
                <div class="bottom-table">
                    <div class="table-header" style="color: #ffd700;">
                        <i class="fas fa-exclamation-circle"></i> VENDOR SUPPORT NOT AVAILABLE
                    </div>
                    <div class="table-content-extra" id="vendor-unsupported-table">
                        <div class="loading">Processing data...</div>
                    </div>
                    <div class="pagination" id="unsupported-pagination"></div>
                </div>
                
                <!-- Table 3: Vendor Response Delayed -->
                <div class="bottom-table" style="margin-top: 20px;">
                    <div class="table-header" style="color: #ffd700;">
                        <i class="fas fa-clock"></i> VENDOR RESPONSE DELAYED
                    </div>
                    <div class="table-content-extra" id="vendor-delayed-table">
                        <div class="loading">Processing data...</div>
                    </div>
                    <div class="pagination" id="delayed-pagination"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google Sheets Configuration
        const SHEET_ID = '1ylgWBQJQgv0HjRiV9Ay-GYs__ywWUk8ZTSeb0KwaPsM';
        const SHEET_GID = '1144899065';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

        // Column Index Mapping (0-based)
        const COLUMNS = {
            A: 0,         // LC/ID
            D: 3,         // CARRIER
            I: 8,         // SHIPPINGLINE
            M: 12,        // JALUR
            Z: 25,        // CBM PLAN
            AN: 39,       // CASE ID PLAN (OLD)
            AO: 40,       // STUFFING DATE
            AP: 41,       // JAM
            AQ: 42,       // CASE ID PLAN (NEW)
            AR: 43,       // KOTA
            AS: 44,       // AREA
            AT: 45,       // REGIONAL
            AX: 49,       // BULAN
            AY: 50,       // CBM SHIPPED
            AZ: 51,       // CASE ID SHIPPED (OLD)
            BA: 52,       // ESTIMASI CASE ID
            BB: 53,       // CASE ID PLAN (BB)
            BC: 54,       // SLA CUSTOMER (HISTORIS)
            BD: 55,       // SLA GRW (HISTORIS)
            BF: 57,       // CASE ID SHIPPED (BF)
            AU: 46,       // JENIS ARMADA
            AV: 47,       // KOTA SUMMARY
            AW: 48        // AGING LC
        };

        // Kota Coordinates - More accurate locations using Google Maps data
        const kotaKoordinat = {
            // Uppercase variations
            'JAKARTA': [-6.2088, 106.8456],
            'SURABAYA': [-7.2575, 112.7521],
            'BALI': [-8.6705, 115.2126],
            'SEMARANG': [-6.9665, 110.4038],
            'BANDUNG': [-6.9175, 107.6191],
            'MEDAN': [3.5952, 98.6722],
            'MAKASSAR': [-5.3520, 119.5215],
            'YOGYAKARTA': [-7.7956, 110.3695],
            'KENDARI': [-3.9456, 122.5144],
            'SOLO': [-7.5505, 110.8242],
            'LOMBOK': [-8.6363, 116.3150],
            'KUDUS': [-6.9089, 110.8044],
            'PALEMBANG': [-2.9444, 104.7467],
            'BATAM': [1.1449, 104.0098],
            'JAMBI': [-1.6331, 103.5467],
            'PEKANBARU': [0.5431, 101.4471],
            'BANJARMASIN': [-3.3256, 114.5887],
            'KUPANG': [-10.1639, 123.5812],
            'MANADO': [1.4748, 124.8228],
            'MATARAM': [-8.5895, 116.2708],
            'PALANGKARAYA': [-1.9674, 111.4328],
            'PONTIANAK': [-0.0305, 109.3433],
            'SAMARINDA': [-0.4948, 117.1889],
            'SERANG': [-6.1256, 106.1505],
            'SEMARANG KOTA': [-6.9665, 110.4038],
            'SURAKARTA': [-7.5505, 110.8242],
            'TANGERANG': [-6.1728, 106.6326],
            'TASIKMALAYA': [-7.3500, 108.2000],
            'TEGAL': [-6.8641, 109.1306],
            'TERSANA': [-7.7500, 110.3833],
            'TOLITOLI': [0.9693, 121.1897],
            'TOMOHON': [1.3167, 124.8167],
            'TORAJA': [-2.9804, 119.6747],
            'TUBAN': [-6.8944, 111.9533],
            'TUNGKAL': [0.3187, 101.6339],
            'UMETARO': [-8.5895, 116.2708],
            'YOGYA': [-7.7956, 110.3695],
            
            // Mixed case variations
            'Jakarta': [-6.2088, 106.8456],
            'Surabaya': [-7.2575, 112.7521],
            'Bali': [-8.6705, 115.2126],
            'Semarang': [-6.9665, 110.4038],
            'Bandung': [-6.9175, 107.6191],
            'Medan': [3.5952, 98.6722],
            'Makassar': [-5.3520, 119.5215],
            'Yogyakarta': [-7.7956, 110.3695],
            'Kendari': [-3.9456, 122.5144],
            'Solo': [-7.5505, 110.8242],
            'Lombok': [-8.6363, 116.3150],
            'Kudus': [-6.9089, 110.8044],
            'Palembang': [-2.9444, 104.7467],
            'Batam': [1.1449, 104.0098],
            'Jambi': [-1.6331, 103.5467],
            'Pekanbaru': [0.5431, 101.4471],
            'Banjarmasin': [-3.3256, 114.5887],
            'Kupang': [-10.1639, 123.5812],
            'Manado': [1.4748, 124.8228],
            'Mataram': [-8.5895, 116.2708],
            'Palangkaraya': [-1.9674, 111.4328],
            'Pontianak': [-0.0305, 109.3433],
            'Samarinda': [-0.4948, 117.1889],
            'Serang': [-6.1256, 106.1505],
            'Surakarta': [-7.5505, 110.8242],
            'Tangerang': [-6.1728, 106.6326],
            'Tasikmalaya': [-7.3500, 108.2000],
            'Tegal': [-6.8641, 109.1306],
            'Tolitoli': [0.9693, 121.1897],
            'Tomohon': [1.3167, 124.8167],
            'Tuban': [-6.8944, 111.9533]
        };

        // Data Storage
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 100;
        let map;
        let markers = [];
        let filterTimeout; // Untuk debouncing
        let slaChart = null;
        let cbmRatioChart = null;
        let vendorResponseChart = null;
        let agingTerlambatChart = null;

        let unsupportedPage = 1;
        let delayedPage = 1;
        const extraItemsPerPage = 15;

        // Register ChartDataLabels plugin globally
        Chart.register(ChartDataLabels);

        // Filter State (Arrays for multi-select)
        let selectedFilters = {
            bulan: [],
            stuffingDate: [],
            kota: [],
            regional: [],
            area: []
        };

        // Helper Function: Parse number with comma separator
        function parseNumberWithComma(value) {
            if (!value) return 0;
            // Hapus pemisah ribuan (koma) dan bersihkan spasi
            const cleaned = String(value).replace(/,/g, '').trim();
            return parseFloat(cleaned) || 0;
        }

        // Initialize Map
        function initMap() {
            map = L.map('map').setView([-2.5489, 118.0149], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        // Fetch Data dari Google Sheets
        async function fetchData() {
            try {
                // Menggunakan credentials: 'omit' untuk menghindari masalah CORS/Cookies di dalam iframe
                const response = await fetch(CSV_URL, { credentials: 'omit' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csv = await response.text();
                
                // Cek apakah yang diterima benar-benar data (bukan halaman login HTML)
                if (csv.trim().startsWith('<!DOCTYPE')) {
                    throw new Error("Diterima format HTML, bukan CSV. Pastikan Google Sheet sudah di-share 'Anyone with the link can view'.");
                }

                parseCSV(csv);
                populateFilters();
                applyFilters();
            } catch (error) {
                console.error('Error fetching data:', error);
                const errorMsg = error.message.includes('fetch') ? 
                    'Gagal terhubung ke Google Sheets. Periksa koneksi internet atau status sharing file.' : 
                    error.message;
                
                document.getElementById('crm-table-container').innerHTML = 
                    `<div class="loading" style="color: #ff6b6b;">
                        <i class="fas fa-exclamation-triangle"></i><br/>
                        Error: ${errorMsg}
                    </div>`;
            }
        }

        // Parse CSV
        function parseCSV(csv) {
            const allRows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;

            // Robust CSV parsing handling quotes and newlines within cells
            for (let i = 0; i < csv.length; i++) {
                const char = csv[i];
                const nextChar = csv[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if ((char === '\n' || (char === '\r' && nextChar === '\n')) && !inQuotes) {
                    currentRow.push(currentField.trim());
                    allRows.push(currentRow);
                    currentRow = [];
                    currentField = '';
                    if (char === '\r') i++; // Skip \n
                } else {
                    currentField += char;
                }
            }
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                allRows.push(currentRow);
            }

            allData = [];
            // Start from i=1 to skip header
            for (let i = 1; i < allRows.length; i++) {
                const values = allRows[i];

                if (values.length > Math.max(...Object.values(COLUMNS))) {
                    const id = (values[COLUMNS.A] || '').trim();
                    const stuffingDate = (values[COLUMNS.AO] || '').trim();
                    const kota = (values[COLUMNS.AR] || '').trim();
                    
                    const cbmPlan = parseNumberWithComma(values[COLUMNS.Z]);
                    const caseIdPlan = parseNumberWithComma(values[COLUMNS.BB]);
                    const cbmShipped = parseNumberWithComma(values[COLUMNS.AY]);
                    const caseIdShipped = parseNumberWithComma(values[COLUMNS.BF]);
                    
                    const idLower = id.toLowerCase();
                    const kotaLower = kota.toLowerCase();
                    const dateLower = stuffingDate.toLowerCase();

                    // VALIDASI KETAT:
                    // 1. Baris data WAJIB memiliki ID, Tanggal Stuffing, dan Kota
                    if (!id || !stuffingDate || !kota) {
                        continue;
                    }

                    // 2. Lewati jika baris header yang berulang
                    if (idLower === 'lc/id' || idLower === 'id' || dateLower.includes('date')) {
                        continue;
                    }

                    // 3. Lewati jika baris ringkasan (Total/Jumlah/Subtotal/Summary)
                    // Kita periksa kolom ID, KOTA, dan TANGGAL
                    const summaryKeywords = ['total', 'jumlah', 'grand', 'subtotal', 'summary'];
                    const isSummary = summaryKeywords.some(k => 
                        idLower.includes(k) || 
                        kotaLower.includes(k) || 
                        dateLower.includes(k)
                    );
                    
                    if (isSummary) {
                        continue;
                    }

                    // 4. Lewati jika baris kosong/dekoratif (semua angka nol penting)
                    if (cbmPlan === 0 && caseIdPlan === 0 && cbmShipped === 0 && caseIdShipped === 0) {
                        continue;
                    }

                    allData.push({
                        A: id,
                        D: values[COLUMNS.D] || '',
                        I: values[COLUMNS.I] || '',
                        M: values[COLUMNS.M] || '',
                        Z: values[COLUMNS.Z] || '0',
                        AO: values[COLUMNS.AO] || '',
                        AP: values[COLUMNS.AP] || '',
                        AQ: values[COLUMNS.AQ] || '0',
                        AR: kota,
                        AS: values[COLUMNS.AS] || '',
                        AT: values[COLUMNS.AT] || '',
                        AX: values[COLUMNS.AX] || '',
                        AY: values[COLUMNS.AY] || '0',
                        AZ: values[COLUMNS.AZ] || '0',
                        BA: values[COLUMNS.BA] || '0',
                        BB: values[COLUMNS.BB] || '0',
                        BC: values[COLUMNS.BC] || '0',
                        BD: values[COLUMNS.BD] || '0',
                        BF: values[COLUMNS.BF] || '0',
                        AU: values[COLUMNS.AU] || '',
                        AV: values[COLUMNS.AV] || '',
                        AW: values[COLUMNS.AW] || '0'
                    });
                }
            }
        }

        // Populate Filter Options
        function populateFilters() {
            const bulanSet = new Set();
            const kotaSet = new Set();
            const regionalSet = new Set();
            const areaSet = new Set();
            const stuffingDateSet = new Set();

            allData.forEach(row => {
                if (row.AX) bulanSet.add(row.AX);
                if (row.AR) kotaSet.add(row.AR);
                if (row.AT) regionalSet.add(row.AT);
                if (row.AS) areaSet.add(row.AS);
                if (row.AO) stuffingDateSet.add(row.AO);
            });

            // Hanya populate jika belum ada opsi (mencegah reset saat auto-refresh)
            // Atau jika Anda ingin selalu update, pastikan state terjaga (sudah ditangani di populateMultiSelect)
            populateMultiSelect('bulan', Array.from(bulanSet).sort(), 'Bulan');
            populateMultiSelect('kota', Array.from(kotaSet).sort(), 'Kota');
            populateMultiSelect('regional', Array.from(regionalSet).sort(), 'Regional');
            populateMultiSelect('area', Array.from(areaSet).sort(), 'Area');
            populateMultiSelect('stuffingDate', Array.from(stuffingDateSet).sort().reverse(), 'Tanggal');
        }

        function populateMultiSelect(filterId, options, label) {
            const optionsContainer = document.getElementById(`${filterId}-options`);
            const displayElement = document.getElementById(`${filterId}-display`);
            
            if (!optionsContainer || !displayElement) return;

            // Simpan state yang sedang terpilih sebelum dikosongkan
            const previouslySelected = selectedFilters[filterId] || [];
            
            optionsContainer.innerHTML = '';

            // Add "Select All" option
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'option-item select-all-btn';
            selectAllDiv.innerHTML = `
                <input type="checkbox" id="${filterId}-all">
                <label for="${filterId}-all">PILIH SEMUA</label>
            `;
            optionsContainer.appendChild(selectAllDiv);

            const allCheckbox = selectAllDiv.querySelector('input');

            options.forEach(option => {
                if (option) {
                    const isChecked = previouslySelected.includes(option);
                    const div = document.createElement('div');
                    div.className = 'option-item';
                    div.innerHTML = `
                        <input type="checkbox" value="${option}" id="${filterId}-${option}" class="${filterId}-checkbox" ${isChecked ? 'checked' : ''}>
                        <label for="${filterId}-${option}">${option}</label>
                    `;
                    optionsContainer.appendChild(div);
                }
            });

            // Event Listeners for checkboxes
            const checkboxes = optionsContainer.querySelectorAll(`.${filterId}-checkbox`);
            
            allCheckbox.addEventListener('change', () => {
                checkboxes.forEach(cb => cb.checked = allCheckbox.checked);
                updateFilterState(filterId);
            });

            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const allChecked = Array.from(checkboxes).every(c => c.checked);
                    allCheckbox.checked = allChecked;
                    updateFilterState(filterId);
                });
            });

            // Update "Select All" state initially
            if (checkboxes.length > 0) {
                allCheckbox.checked = Array.from(checkboxes).every(c => c.checked);
            }

            // Gunakan onclick untuk memastikan hanya ada SATU listener (mencegah bug klik ganda)
            displayElement.onclick = (e) => {
                e.stopPropagation();
                // Close other dropdowns
                document.querySelectorAll('.multi-select-options').forEach(opt => {
                    if (opt.id !== `${filterId}-options`) opt.classList.remove('show');
                });
                optionsContainer.classList.toggle('show');
            };
        }

        function updateFilterState(filterId) {
            const checkboxes = document.querySelectorAll(`.${filterId}-checkbox:checked`);
            selectedFilters[filterId] = Array.from(checkboxes).map(cb => cb.value);
            
            const displayElement = document.getElementById(`${filterId}-display`);
            const count = selectedFilters[filterId].length;
            const totalCount = document.querySelectorAll(`.${filterId}-checkbox`).length;
            
            if (count === 0) {
                displayElement.textContent = `-- Semua ${filterId.charAt(0).toUpperCase() + filterId.slice(1)} --`;
            } else if (count === totalCount) {
                displayElement.textContent = `Semua Terpilih (${count})`;
            } else {
                displayElement.textContent = `${count} Terpilih`;
            }
            
            // DEBOUNCING: Tunggu 300ms sebelum apply filter agar lancar
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                applyFilters();
            }, 300);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.multi-select-options').forEach(opt => {
                opt.classList.remove('show');
            });
        });

        // Prevent dropdown close when clicking inside options
        document.querySelectorAll('.multi-select-options').forEach(opt => {
            opt.addEventListener('click', (e) => e.stopPropagation());
        });

        // Apply Filters
        function applyFilters() {
            filteredData = allData.filter(row => {
                const matchBulan = selectedFilters.bulan.length === 0 || selectedFilters.bulan.includes(row.AX);
                const matchDate = selectedFilters.stuffingDate.length === 0 || selectedFilters.stuffingDate.includes(row.AO);
                const matchKota = selectedFilters.kota.length === 0 || selectedFilters.kota.includes(row.AR);
                const matchRegional = selectedFilters.regional.length === 0 || selectedFilters.regional.includes(row.AT);
                const matchArea = selectedFilters.area.length === 0 || selectedFilters.area.includes(row.AS);

                return matchBulan && matchDate && matchKota && matchRegional && matchArea;
            });

            currentPage = 1;
            updateDashboard();
        }

        // Get JAM color class - Updated schedule
        function getJamColorClass(jam) {
            if (!jam) return '';
            
            const jamNum = parseFloat(jam);
            
            // 08.00-10.00 : kuning muda
            if (jamNum >= 8 && jamNum < 10) {
                return 'jam-pagi';
            } 
            // 12.00-14.00 : biru muda
            else if (jamNum >= 12 && jamNum < 14) {
                return 'jam-siang';
            } 
            // 15.00-18.00 : hijau muda
            else if (jamNum >= 15 && jamNum < 18) {
                return 'jam-sore';
            } 
            // 19.00-21.00 : abu abu muda
            else if (jamNum >= 19 && jamNum < 21) {
                return 'jam-malam';
            }
            return '';
        }

        // Update Dashboard
        function updateDashboard() {
            try {
                // Jalankan update secara berurutan agar tidak membekukan browser
                updateKPIs();
                updateCRMTable();
                updateShippingTable();
                updateMap();
                updateCharts();
                updateExtraSection();
            } catch (error) {
                console.error("Error updating dashboard:", error);
            }
        }

        // Update Charts
        function updateCharts() {
            const dailyData = {};
            
            // Aggregate data by date
            filteredData.forEach(row => {
                const date = row.AO;
                if (!date) return;
                
                if (!dailyData[date]) {
                    dailyData[date] = {
                        cbmPlan: 0,
                        cbmShipped: 0,
                        slaCustomerSum: 0,
                        slaGrwSum: 0,
                        count: 0
                    };
                }
                
                dailyData[date].cbmPlan += parseNumberWithComma(row.Z);
                dailyData[date].cbmShipped += parseNumberWithComma(row.AY);
                
                // Ambil data historis dari kolom BC dan BD
                // Kita asumsikan data di sheet dalam bentuk desimal (0.98) atau persentase (98)
                // Kita akan merata-ratakannya jika ada beberapa baris di tanggal yang sama
                dailyData[date].slaCustomerSum += parseNumberWithComma(row.BC);
                dailyData[date].slaGrwSum += parseNumberWithComma(row.BD);
                dailyData[date].count++;
            });

            // Sort dates
            const sortedDates = Object.keys(dailyData).sort();
            const labels = sortedDates;
            
            // Prepare datasets
            const slaCustomerData = sortedDates.map(date => {
                const d = dailyData[date];
                if (d.count === 0 || d.slaCustomerSum === 0) return null;
                const val = d.slaCustomerSum / d.count;
                // Jika nilai < 2, asumsikan itu desimal (misal 0.98), maka kali 100
                const finalVal = val < 2 ? val * 100 : val;
                return finalVal === 0 ? null : finalVal;
            });

            const slaGrwData = sortedDates.map(date => {
                const d = dailyData[date];
                if (d.count === 0 || d.slaGrwSum === 0) return null;
                const val = d.slaGrwSum / d.count;
                const finalVal = val < 2 ? val * 100 : val;
                return finalVal === 0 ? null : finalVal;
            });
            
            const cbmRatioData = sortedDates.map(date => {
                const d = dailyData[date];
                if (d.cbmPlan === 0) return null;
                const ratio = (d.cbmShipped / d.cbmPlan) * 100;
                return ratio === 0 ? null : ratio;
            });

            // SLA Chart
            const slaCtx = document.getElementById('slaChart').getContext('2d');
            if (slaChart) slaChart.destroy();
            slaChart = new Chart(slaCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'SLA CUSTOMER (Target 100%)',
                            data: slaCustomerData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            pointRadius: 4,
                            tension: 0.1
                        },
                        {
                            label: 'SLA GRW (Actual)',
                            data: slaGrwData,
                            borderColor: '#2dd4bf',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#2dd4bf',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // Mematikan animasi agar tidak bergerak/flicker
                    scales: {
                        y: {
                            // Menyesuaikan range agar fluktuasi terlihat
                            ticks: {
                                color: '#aaa',
                                callback: value => value + '%'
                            },
                            grid: { color: '#333' }
                        },
                        x: {
                            ticks: { color: '#aaa' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#fff', font: { weight: 'bold' } }
                        },
                        datalabels: {
                            anchor: (context) => {
                                const val = context.dataset.data[context.dataIndex];
                                return (val !== null && val < 100) ? 'center' : 'end';
                            },
                            align: (context) => {
                                const val = context.dataset.data[context.dataIndex];
                                return (val !== null && val < 100) ? 'right' : 'top';
                            },
                            offset: 5,
                            color: (context) => context.dataset.borderColor,
                            font: { weight: 'bold', size: 10 },
                            formatter: (value) => value === null ? '' : value.toFixed(1) + '%',
                            display: (context) => {
                                const data = context.dataset.data;
                                const validData = data.filter(v => v !== null);
                                if (validData.length === 0 || context.dataset.data[context.dataIndex] === null) return false;
                                
                                const max = Math.max(...validData);
                                const min = Math.min(...validData);
                                const currentVal = context.dataset.data[context.dataIndex];
                                
                                // Tampilkan hanya jika nilai adalah Max pertama atau Min pertama di antara data valid
                                return currentVal === max && context.dataIndex === data.indexOf(max) || 
                                       currentVal === min && context.dataIndex === data.indexOf(min);
                            }
                        }
                    }
                }
            });

            // CBM Ratio Chart
            const cbmCtx = document.getElementById('cbmRatioChart').getContext('2d');
            if (cbmRatioChart) cbmRatioChart.destroy();
            cbmRatioChart = new Chart(cbmCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'CBM Plan-to-Actual Ratio (%)',
                        data: cbmRatioData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        borderWidth: 3,
                        pointRadius: 4,
                        pointBackgroundColor: '#3b82f6',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // Mematikan animasi
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#aaa',
                                callback: value => value + '%'
                            },
                            grid: { color: '#333' }
                        },
                        x: {
                            ticks: { color: '#aaa' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: context => `Ratio: ${context.parsed.y.toFixed(1)}%`
                            }
                        },
                        datalabels: {
                            anchor: 'start',
                            align: 'bottom',
                            offset: 5,
                            color: '#fff',
                            font: { weight: 'bold', size: 10 },
                            formatter: (value) => value === null ? '' : value.toFixed(1) + '%',
                            backgroundColor: 'rgba(0,0,0,0.5)',
                            borderRadius: 3,
                            padding: 2,
                            display: (context) => {
                                const data = context.dataset.data;
                                const validData = data.filter(v => v !== null);
                                if (validData.length === 0 || context.dataset.data[context.dataIndex] === null) return false;
                                
                                const max = Math.max(...validData);
                                const min = Math.min(...validData);
                                const currentVal = context.dataset.data[context.dataIndex];
                                
                                return currentVal === max && context.dataIndex === data.indexOf(max) || 
                                       currentVal === min && context.dataIndex === data.indexOf(min);
                            }
                        }
                    }
                }
            });
        }

        // Helper: Calculate Aging
        function getAgingLC(row) {
            // Mengambil langsung dari kolom AW sesuai permintaan
            return row.AW || '0';
        }

        // Helper: Status Checkers
        function isBelumSupport(row) {
            const carrier = (row.D || '').toUpperCase();
            return !carrier || carrier.includes('BELUM SUPPORT') || carrier.includes('TBA') || carrier.includes('DUMMY');
        }

        function isTerlambat(row) {
            if (isBelumSupport(row)) return false;
            // Kriteria terlambat: Shipped 0 dan ada nilai di Aging LC (asumsi aging > 0 berarti terlambat)
            const aging = parseInt(row.AW) || 0;
            const shipped = parseNumberWithComma(row.AY);
            return aging > 0 && shipped === 0;
        }

        // Update Extra Section (Tables & Charts from Image)
        function updateExtraSection() {
            const cityStats = {};
            const unsupportedList = [];
            const delayedList = [];
            
            let totalOnTime = 0;
            let totalTerlambat = 0;
            let totalBelumSupport = 0;
            
            const agingGroups = {
                '1 Hari': 0,
                '2 Hari': 0,
                '3 Hari': 0,
                '4 Hari': 0,
                '5 Hari': 0,
                '> 5 Hari': 0
            };

            filteredData.forEach(row => {
                // Gunakan kolom AR untuk ringkasan kota sesuai permintaan terbaru
                const kotaSummary = row.AR || 'UNKNOWN';
                const cbm = parseNumberWithComma(row.Z);
                const aging = parseInt(row.AW) || 0;
                const armada = (row.AU || '').toUpperCase();

                if (!cityStats[kotaSummary]) {
                    cityStats[kotaSummary] = { tCbm: 0, tQty: 0, uCbm: 0, uQty: 0 };
                }

                if (isBelumSupport(row)) {
                    cityStats[kotaSummary].uCbm += cbm;
                    cityStats[kotaSummary].uQty++;
                    unsupportedList.push(row);
                    totalBelumSupport++;
                } else if (isTerlambat(row)) {
                    cityStats[kotaSummary].tCbm += cbm;
                    cityStats[kotaSummary].tQty++;
                    
                    // Filter: Hanya tampilkan jenis armada CONT untuk tabel Delayed
                    if (armada.includes('CONT')) {
                        delayedList.push(row);
                    }
                    
                    totalTerlambat++;
                    
                    // Aging groups based on AW
                    if (aging === 1) agingGroups['1 Hari']++;
                    else if (aging === 2) agingGroups['2 Hari']++;
                    else if (aging === 3) agingGroups['3 Hari']++;
                    else if (aging === 4) agingGroups['4 Hari']++;
                    else if (aging === 5) agingGroups['5 Hari']++;
                    else if (aging > 5) agingGroups['> 5 Hari']++;
                } else {
                    totalOnTime++;
                }
            });

            // Sort Unsupported List by LC (A-Z)
            unsupportedList.sort((a, b) => (a.A || '').localeCompare(b.A || ''));

            renderCitySummaryTable(cityStats);
            renderVendorUnsupportedTable(unsupportedList);
            renderVendorDelayedTable(delayedList);
            renderExtraCharts(totalOnTime, totalTerlambat, totalBelumSupport, agingGroups);
        }

        function renderCitySummaryTable(stats) {
            const container = document.getElementById('city-summary-table');
            let totalTCbm = 0, totalTQty = 0, totalUCbm = 0, totalUQty = 0;

            let html = `
                <table>
                    <thead>
                        <tr class="nested-header">
                            <th rowspan="2">KOTA</th>
                            <th colspan="2">TERLAMBAT</th>
                            <th colspan="2">BELUM SUPPORT</th>
                        </tr>
                        <tr class="sub-header">
                            <th>CBM</th>
                            <th>JUMLAH</th>
                            <th>CBM</th>
                            <th>JUMLAH</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.keys(stats).sort().forEach(kota => {
                const s = stats[kota];
                if (s.tQty === 0 && s.uQty === 0) return;
                
                totalTCbm += s.tCbm;
                totalTQty += s.tQty;
                totalUCbm += s.uCbm;
                totalUQty += s.uQty;

                html += `
                    <tr>
                        <td>${kota}</td>
                        <td>${s.tCbm.toFixed(2)}</td>
                        <td>${s.tQty}</td>
                        <td>${s.uCbm.toFixed(2)}</td>
                        <td>${s.uQty}</td>
                    </tr>
                `;
            });

            html += `
                </tbody>
                <tfoot>
                    <tr>
                        <td>Total kesel...</td>
                        <td>${totalTCbm.toFixed(2)}</td>
                        <td>${totalTQty}</td>
                        <td>${totalUCbm.toFixed(2)}</td>
                        <td>${totalUQty}</td>
                    </tr>
                </tfoot>
                </table>
            `;
            container.innerHTML = html;
        }

        function renderVendorUnsupportedTable(list) {
            const container = document.getElementById('vendor-unsupported-table');
            const start = (unsupportedPage - 1) * extraItemsPerPage;
            const end = start + extraItemsPerPage;
            const pageData = list.slice(start, end);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>LC</th>
                            <th>CARRIER</th>
                            <th>JALUR</th>
                            <th>LOAD DATE</th>
                            <th>CBM</th>
                            <th>AGING LC</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageData.forEach((row, i) => {
                const aging = row.AW || '0';
                html += `
                    <tr>
                        <td>${start + i + 1}</td>
                        <td>${row.A}</td>
                        <td>${row.D || '-'}</td>
                        <td>${row.M || '-'}</td>
                        <td>${row.AO} ${row.AP}</td>
                        <td>${parseNumberWithComma(row.Z).toFixed(2)}</td>
                        <td>${aging} HARI</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Simple pagination
            const totalPages = Math.ceil(list.length / extraItemsPerPage);
            document.getElementById('unsupported-pagination').innerHTML = `
                <div style="padding:10px; text-align:right; font-size:0.8em; color:#aaa;">
                    ${start + 1}-${Math.min(end, list.length)} / ${list.length}
                    <button onclick="unsupportedPage=Math.max(1, unsupportedPage-1); updateExtraSection()" ${unsupportedPage===1?'disabled':''}>â¹</button>
                    <button onclick="unsupportedPage=Math.min(${totalPages}, unsupportedPage+1); updateExtraSection()" ${unsupportedPage===totalPages?'disabled':''}>âº</button>
                </div>
            `;
        }

        function renderVendorDelayedTable(list) {
            const container = document.getElementById('vendor-delayed-table');
            const start = (delayedPage - 1) * extraItemsPerPage;
            const end = start + extraItemsPerPage;
            const pageData = list.slice(start, end);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>LC</th>
                            <th>CARRIER</th>
                            <th>JALUR</th>
                            <th>LOAD DATE</th>
                            <th>CBM</th>
                            <th>AGING LC</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageData.forEach((row, i) => {
                const aging = row.AW || '0';
                html += `
                    <tr>
                        <td>${start + i + 1}</td>
                        <td>${row.A}</td>
                        <td>${row.D || '-'}</td>
                        <td>${row.M || '-'}</td>
                        <td>${row.AO} ${row.AP}</td>
                        <td>${parseNumberWithComma(row.Z).toFixed(2)}</td>
                        <td>${aging} HARI</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;

            const totalPages = Math.ceil(list.length / extraItemsPerPage);
            document.getElementById('delayed-pagination').innerHTML = `
                <div style="padding:10px; text-align:right; font-size:0.8em; color:#aaa;">
                    ${start + 1}-${Math.min(end, list.length)} / ${list.length}
                    <button onclick="delayedPage=Math.max(1, delayedPage-1); updateExtraSection()" ${delayedPage===1?'disabled':''}>â¹</button>
                    <button onclick="delayedPage=Math.min(${totalPages}, delayedPage+1); updateExtraSection()" ${delayedPage===totalPages?'disabled':''}>âº</button>
                </div>
            `;
        }

        function renderExtraCharts(onTime, terlambat, belumSupport, agingGroups) {
            const total = onTime + terlambat + belumSupport;
            const pOnTime = total ? (onTime / total * 100).toFixed(0) : 0;
            const pTerlambat = total ? (terlambat / total * 100).toFixed(0) : 0;
            const pBelumSupport = total ? (belumSupport / total * 100).toFixed(0) : 0;

            // Vendor Response Chart
            const vrCtx = document.getElementById('vendorResponseChart').getContext('2d');
            if (vendorResponseChart) vendorResponseChart.destroy();
            vendorResponseChart = new Chart(vrCtx, {
                type: 'bar',
                data: {
                    labels: ['TERLAMBAT', 'ON TIME', 'BELUM SUPPORT'],
                    datasets: [{
                        label: 'VENDOR RESPONSE',
                        data: [pTerlambat, pOnTime, pBelumSupport],
                        backgroundColor: ['#d32f2f', '#3b82f6', '#555'],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#fff',
                            formatter: (val) => val + '%'
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { color: '#333' }, ticks: { color: '#aaa' } },
                        x: { ticks: { color: '#aaa' }, grid: { display: false } }
                    }
                }
            });

            // Aging Terlambat Chart
            const atCtx = document.getElementById('agingTerlambatChart').getContext('2d');
            if (agingTerlambatChart) agingTerlambatChart.destroy();
            
            const agingLabels = Object.keys(agingGroups);
            const agingData = Object.values(agingGroups);
            const totalAging = agingData.reduce((a, b) => a + b, 0);

            agingTerlambatChart = new Chart(atCtx, {
                type: 'bar',
                data: {
                    labels: agingLabels,
                    datasets: [{
                        label: 'TERLAMBAT',
                        data: agingData.map(v => totalAging ? (v / totalAging * 100).toFixed(0) : 0),
                        backgroundColor: '#3b82f6',
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#fff',
                            formatter: (val) => val + '%'
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 100, grid: { color: '#333' }, ticks: { color: '#aaa' } },
                        y: { ticks: { color: '#aaa' }, grid: { display: false } }
                    }
                }
            });
        }

        // Update CRM Table
        function updateCRMTable() {
            const container = document.getElementById('crm-table-container');

            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">No data found</div>';
                return;
            }

            const kotaData = {};
            const dates = new Set();

            // Optimasi: Gunakan loop tunggal untuk agregasi
            for (let i = 0; i < filteredData.length; i++) {
                const row = filteredData[i];
                const kota = row.AR;
                const date = row.AO;
                
                if (!kota) continue;

                if (!kotaData[kota]) kotaData[kota] = {};
                if (!kotaData[kota][date]) {
                    kotaData[kota][date] = 0;
                    dates.add(date);
                }
                kotaData[kota][date] += parseNumberWithComma(row.Z);
            }

            // Sort dates from newest to oldest (limit to 4 for performance)
            const sortedDates = Array.from(dates).sort().reverse().slice(0, 4);
            const dateTotals = {};
            sortedDates.forEach(date => dateTotals[date] = 0);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>KOTA</th>
                            ${sortedDates.map(date => `<th>${date}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

            Object.keys(kotaData).sort((a, b) => a.localeCompare(b)).forEach(kota => {
                html += `<tr><td>${kota}</td>`;
                sortedDates.forEach(date => {
                    const cbm = kotaData[kota][date] || 0;
                    html += `<td>${cbm ? cbm.toFixed(2) : '-'}</td>`;
                    dateTotals[date] += cbm;
                });
                html += `</tr>`;
            });

            html += `</tbody>`;

            // Add Total Row
            html += `
                <tfoot>
                    <tr>
                        <td>TOTAL</td>
                        ${sortedDates.map(date => `<td>${dateTotals[date].toFixed(2)}</td>`).join('')}
                    </tr>
                </tfoot>
            `;

            html += `</table>`;
            container.innerHTML = html;
        }

        // Update Shipping Table
        function updateShippingTable() {
            const container = document.getElementById('shipping-table-container');

            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">No data found</div>';
                return;
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>LC</th>
                            <th>SHIPPINGLINE</th>
                            <th>CARRIER</th>
                            <th>STUFFING</th>
                            <th>JAM</th>
                            <th>JALUR</th>
                            <th>PLAN</th>
                            <th>SHIPPED</th>
                            <th>FIX CASE ID</th>
                            <th>ESTIMASI CASE ID</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            pageData.forEach((row, index) => {
                const rowNum = start + index + 1;
                const jamColorClass = getJamColorClass(row.AP);
                // Parse dengan fungsi helper untuk menghapus koma
                const estimasiCaseId = parseNumberWithComma(row.BA);

                html += `
                    <tr class="${jamColorClass}">
                        <td>${rowNum}</td>
                        <td>${row.A || '-'}</td>
                        <td>${row.I || '-'}</td>
                        <td>${row.D || '-'}</td>
                        <td>${row.AO || '-'}</td>
                        <td>${row.AP || '-'}</td>
                        <td>${row.M || '-'}</td>
                        <td>${parseNumberWithComma(row.Z).toFixed(2) || '-'}</td>
                        <td>${parseNumberWithComma(row.AY).toFixed(2) || '-'}</td>
                        <td>${parseNumberWithComma(row.AQ).toFixed(0) || '-'}</td>
                        <td>${estimasiCaseId.toFixed(0) || '-'}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            updatePagination(totalPages);
        }

        // Update Pagination
        function updatePagination(totalPages) {
            const pagination = document.getElementById('pagination');
            let html = `Page ${currentPage} / ${totalPages} &nbsp;`;

            if (currentPage > 1) {
                html += `<button onclick="goToPage(1)">Â« First</button>
                         <button onclick="goToPage(${currentPage - 1})">â¹ Prev</button>`;
            }

            if (currentPage < totalPages) {
                html += `<button onclick="goToPage(${currentPage + 1})">Next âº</button>
                         <button onclick="goToPage(${totalPages})">Last Â»</button>`;
            }

            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            updateShippingTable();
            document.querySelector('.table-content-large').scrollTop = 0;
        }

        // Update KPIs
        function updateKPIs() {
            const caseIdShipped = filteredData.reduce((sum, r) => sum + parseNumberWithComma(r.BF), 0);
            const caseIdPlan = filteredData.reduce((sum, r) => sum + parseNumberWithComma(r.BB), 0);
            const cbmPlan = filteredData.reduce((sum, r) => sum + parseNumberWithComma(r.Z), 0);
            const cbmShipped = filteredData.reduce((sum, r) => sum + parseNumberWithComma(r.AY), 0);

            // Calculate B1, B2, B3, B4
            let b1 = 0, b2 = 0, b3 = 0, b4 = 0;
            
            filteredData.forEach(row => {
                const jam = parseFloat(row.AP);
                const val = parseNumberWithComma(row.BB);
                if (isNaN(jam)) return;

                if (jam >= 8 && jam <= 10) b1 += val;
                else if (Math.floor(jam) === 13) b2 += val;
                else if (jam >= 16 && jam <= 18) b3 += val;
                else if (jam >= 19 && jam <= 21) b4 += val;
            });

            document.getElementById('caseIdShipped').textContent = caseIdShipped.toLocaleString('id-ID', {maximumFractionDigits: 0});
            document.getElementById('caseIdPlan').textContent = caseIdPlan.toLocaleString('id-ID', {maximumFractionDigits: 0});
            document.getElementById('cbmPlan').textContent = cbmPlan.toFixed(2);
            document.getElementById('cbmShipped').textContent = cbmShipped.toFixed(2);

            document.getElementById('caseIdPlanB1').textContent = b1.toLocaleString('id-ID', {maximumFractionDigits: 0});
            document.getElementById('caseIdPlanB2').textContent = b2.toLocaleString('id-ID', {maximumFractionDigits: 0});
            document.getElementById('caseIdPlanB3').textContent = b3.toLocaleString('id-ID', {maximumFractionDigits: 0});
            document.getElementById('caseIdPlanB4').textContent = b4.toLocaleString('id-ID', {maximumFractionDigits: 0});
        }

        // Update Map - More accurate city locations
        function updateMap() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            const kotaCount = {};
            const kotaCBM = {};

            filteredData.forEach(row => {
                const kota = row.AR;
                const cbm = parseNumberWithComma(row.Z);

                if (kota) {
                    kotaCount[kota] = (kotaCount[kota] || 0) + 1;
                    kotaCBM[kota] = (kotaCBM[kota] || 0) + cbm;
                }
            });

            Object.keys(kotaCount).forEach(kota => {
                // Try to find coordinates from the mapping
                let coords = kotaKoordinat[kota];
                
                // If not found, try trimmed version
                if (!coords && kota.trim()) {
                    coords = kotaKoordinat[kota.trim()];
                }
                
                if (coords) {
                    const count = kotaCount[kota];
                    const cbm = kotaCBM[kota];

                    const marker = L.circleMarker(coords, {
                        radius: Math.min(Math.max(count / 2, 8), 25),
                        fillColor: '#d32f2f',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).bindPopup(`<strong>${kota}</strong><br/>Jumlah: ${count}<br/>CBM: ${cbm.toFixed(2)}`).addTo(map);
                    markers.push(marker);
                }
            });
        }

        // Event Listeners (Removed old listeners, logic handled in checkboxes)
        
        // Auto-refresh every 30 seconds
        setInterval(fetchData, 30000);

        // Initialize
        initMap();
        fetchData();
    </script>
</body>
</html>
